generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & ORGS ====================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  name              String?
  avatar            String?
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  memberships       OrganizationMember[]
  refreshTokens     RefreshToken[]
}

model Organization {
  id                String    @id @default(cuid())
  name              String
  slug              String    @unique
  logo              String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  members           OrganizationMember[]
  bots              Bot[]
  automations       Automation[]
  contacts          Contact[]
  subscription      Subscription?
  apiKeys           ApiKey[]
}

model OrganizationMember {
  id                String    @id @default(cuid())
  role              MemberRole @default(MEMBER)
  createdAt         DateTime  @default(now())

  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

model RefreshToken {
  id                String    @id @default(cuid())
  token             String    @unique
  expiresAt         DateTime
  createdAt         DateTime  @default(now())

  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ApiKey {
  id                String    @id @default(cuid())
  name              String
  key               String    @unique
  lastUsedAt        DateTime?
  createdAt         DateTime  @default(now())

  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ==================== BOTS ====================

model Bot {
  id                String    @id @default(cuid())
  name              String
  platform          Platform
  isActive          Boolean   @default(true)
  
  platformBotId     String?
  username          String?
  accessToken       String?
  refreshToken      String?
  tokenExpiresAt    DateTime?
  webhookSecret     String?
  
  settings          Json      @default("{}")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  contacts          Contact[]
  conversations     Conversation[]
  automationBots    AutomationBot[]

  @@unique([platform, platformBotId])
}

enum Platform {
  TELEGRAM
  INSTAGRAM
  TIKTOK
}

// ==================== CONTACTS & MESSAGES ====================

model Contact {
  id                String    @id @default(cuid())
  platformUserId    String
  platform          Platform
  
  username          String?
  firstName         String?
  lastName          String?
  avatar            String?
  phone             String?
  email             String?
  
  tags              String[]  @default([])
  points            Int       @default(0)
  customFields      Json      @default("{}")
  
  isSubscribed      Boolean   @default(true)
  subscribedAt      DateTime  @default(now())
  unsubscribedAt    DateTime?
  
  lastActiveAt      DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  botId             String
  bot               Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  conversations     Conversation[]
  messages          Message[]

  @@unique([platform, platformUserId, botId])
}

model Conversation {
  id                String    @id @default(cuid())
  status            ConversationStatus @default(OPEN)
  
  lastMessageAt     DateTime?
  closedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  contactId         String
  contact           Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  botId             String
  bot               Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  messages          Message[]

  @@unique([contactId, botId])
}

enum ConversationStatus {
  OPEN
  CLOSED
  ARCHIVED
}

model Message {
  id                String    @id @default(cuid())
  platformMessageId String?
  
  direction         MessageDirection
  type              MessageType @default(TEXT)
  content           String
  metadata          Json      @default("{}")
  
  status            MessageStatus @default(SENT)
  sentAt            DateTime?
  deliveredAt       DateTime?
  readAt            DateTime?
  
  createdAt         DateTime  @default(now())

  conversationId    String
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  contactId         String
  contact           Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  BUTTONS
  CAROUSEL
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ==================== AUTOMATIONS ====================

model Automation {
  id                String    @id @default(cuid())
  name              String
  description       String?
  isActive          Boolean   @default(false)
  
  triggerType       TriggerType
  triggerConfig     Json      @default("{}")
  
  nodes             Json      @default("[]")
  edges             Json      @default("[]")
  
  executionCount    Int       @default(0)
  lastExecutedAt    DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  automationBots    AutomationBot[]
  executions        AutomationExecution[]
}

enum TriggerType {
  MESSAGE
  KEYWORD
  COMMAND
  BUTTON_CLICK
  SUBSCRIPTION
}

model AutomationBot {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())

  automationId      String
  automation        Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  botId             String
  bot               Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([automationId, botId])
}

model AutomationExecution {
  id                String    @id @default(cuid())
  status            ExecutionStatus @default(RUNNING)
  
  currentNodeId     String?
  variables         Json      @default("{}")
  logs              Json      @default("[]")
  error             String?
  
  startedAt         DateTime  @default(now())
  completedAt       DateTime?

  automationId      String
  automation        Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  contactId         String?

  @@index([automationId, startedAt])
}

enum ExecutionStatus {
  RUNNING
  COMPLETED
  FAILED
  PAUSED
}

// ==================== BILLING ====================

model Subscription {
  id                String    @id @default(cuid())
  plan              SubscriptionPlan @default(FREE)
  status            SubscriptionStatus @default(ACTIVE)
  
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  stripePriceId         String?
  
  monthlyInteractions   Int       @default(200)
  usedInteractions      Int       @default(0)
  
  currentPeriodStart    DateTime  @default(now())
  currentPeriodEnd      DateTime?
  canceledAt            DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organizationId    String    @unique
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

enum SubscriptionPlan {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}
